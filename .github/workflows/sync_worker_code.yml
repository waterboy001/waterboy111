# æ–‡ä»¶ä½ç½®: .github/workflows/sync_worker_code.yml
name: åŒæ­¥ä¸Šæ¸¸ Worker ä»£ç  (Zip è§£å‹ä¼˜åŒ–ç‰ˆ)

on:
  schedule:
    - cron: '0 2 * * 1'   # æ¯å‘¨ä¸€02:00 UTCè¿è¡Œä¸€æ¬¡
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write

    steps:
      - name: Checkout ä»“åº“
        uses: actions/checkout@v4

      # æ­¥éª¤ 1: è·å–ç‰ˆæœ¬ä¿¡æ¯å¹¶åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
      - name: æ£€æŸ¥ç‰ˆæœ¬å¹¶è·å–æœ€æ–°ç‰ˆæœ¬
        id: check_versions
        run: |
          # 1. è·å–æœ€æ–°æ­£å¼ç‰ˆæ ‡ç­¾
          LATEST_TAG=$(curl -s https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases/latest | jq -r '.tag_name')
          
          if [ -z "$LATEST_TAG" ]; then
            echo "::error::æœªæ‰¾åˆ°æœ€æ–°æ­£å¼å‘å¸ƒç‰ˆæœ¬ï¼Œé€€å‡ºã€‚"
            exit 1
          fi
          
          # 2. è·å–æœ¬åœ°ç‰ˆæœ¬
          if [ -f "version.txt" ]; then
            CURRENT_VERSION=$(cat version.txt | tr -d '\n' | tr -d '\r')
          else
            CURRENT_VERSION=""
          fi
          
          echo "æœ€æ–°ç‰ˆæœ¬: $LATEST_TAG"
          echo "å½“å‰æœ¬åœ°ç‰ˆæœ¬: ${CURRENT_VERSION:-æœªæ‰¾åˆ°}"
          
          # 3. æ¯”è¾ƒç‰ˆæœ¬ï¼Œè®¾ç½®æ˜¯å¦éœ€è¦æ›´æ–°
          if [ "$CURRENT_VERSION" = "$LATEST_TAG" ]; then
            echo "No update needed."
            echo "need_update=false" >> $GITHUB_ENV
          else
            echo "Update needed. New tag: $LATEST_TAG"
            echo "latest_tag=$LATEST_TAG" >> $GITHUB_ENV
            echo "need_update=true" >> $GITHUB_ENV
            echo "download_url=https://github.com/bia-pain-bache/BPB-Worker-Panel/releases/download/$LATEST_TAG/worker.zip" >> $GITHUB_ENV
          fi

      # æ­¥éª¤ 2: ä¸‹è½½ã€è§£å‹æ–‡ä»¶å¹¶æ›´æ–°ç‰ˆæœ¬å· (ä»…åœ¨éœ€è¦æ›´æ–°æ—¶æ‰§è¡Œ)
      # ä¼˜åŒ–ï¼šä¸å†æ‰‹åŠ¨å®‰è£… unzipï¼Œubuntu-latest é»˜è®¤åŒ…å«äº†å¤§å¤šæ•°å¸¸ç”¨å·¥å…·
      - name: ä¸‹è½½å¹¶è§£å‹ worker.zip
        if: env.need_update == 'true'
        run: |
          TEMP_ZIP="worker_temp.zip"
          
          echo "æ­£åœ¨ä¸‹è½½æ–‡ä»¶: ${{ env.download_url }}"
          # ä½¿ç”¨ curl ä¸‹è½½ zip æ–‡ä»¶
          curl -L -o "$TEMP_ZIP" "${{ env.download_url }}"
          
          echo "æ­£åœ¨è§£å‹æ–‡ä»¶..."
          # è§£å‹ zip æ–‡ä»¶åˆ°å½“å‰ç›®å½•ï¼Œè¿™å°†è¦†ç›– _worker.js
          unzip -o "$TEMP_ZIP"
          
          # åˆ é™¤ä¸´æ—¶ä¸‹è½½çš„ zip æ–‡ä»¶
          rm "$TEMP_ZIP"
          
          # å°†æœ€æ–°æ ‡ç­¾åå†™å…¥ version.txt
          echo "${{ env.latest_tag }}" > version.txt

      # æ­¥éª¤ 3: æäº¤æ›´æ”¹ (ä½¿ç”¨ä¸“ç”¨çš„ Git Auto Commit Action æ›¿ä»£åŸç”Ÿ git å‘½ä»¤)
      # ä¼˜åŒ–ï¼šä½¿ç”¨ Action æ›¿ä»£ 4 è¡ŒåŸç”Ÿ shell å‘½ä»¤
      - name: æäº¤æ›´æ–°åˆ° GitHub
        if: env.need_update == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ Auto Sync Worker: Update to version ${{ env.latest_tag }}"
          # ä¸ä½¿ç”¨ --forceï¼Œå› ä¸ºæˆ‘ä»¬åªæ˜¯åœ¨æ·»åŠ æˆ–ä¿®æ”¹ _worker.js å’Œ version.txt
